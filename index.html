<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–û–Ω–ª–∞–π–Ω —à–∞—Ö–º–∞—Ç—ã</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Chess.js -->
<script src="https://unpkg.com/chess.js@1.0.0/chess.js"></script>

<!-- Chessboard.js -->
<link rel="stylesheet" href="https://unpkg.com/chessboardjs@1.0.0/www/css/chessboard.css">
<script src="https://unpkg.com/chessboardjs@1.0.0/www/js/chessboard.js"></script>

<style>
body { font-family: Arial; text-align:center; background:#f4f4f4; }
#board { width:400px; margin:20px auto; }
#status { font-size:18px; margin-top:10px; }
#overlay { position:fixed; inset:0; background:rgba(0,0,0,0.75); color:white; display:none; align-items:center; justify-content:center; flex-direction:column; font-size:24px; z-index:10; }
button { margin-top:20px; padding:10px 25px; font-size:18px; cursor:pointer; }
</style>
</head>
<body>

<h2>–û–Ω–ª–∞–π–Ω —à–∞—Ö–º–∞—Ç—ã</h2>
<div id="board"></div>
<div id="status">–û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞‚Ä¶</div>

<div id="overlay">
  <div id="result"></div>
  <button onclick="restartGame()">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
</div>

<script>
/* üî• FIREBASE CONFIG üî• */
const firebaseConfig = {
  apiKey: "AIzaSyB4UtIoIiS3Lq4ml7dvgWeg6b8bA8sqxNg",
  authDomain: "chess-d3fd7.firebaseapp.com",
  databaseURL: "https://chess-d3fd7-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "chess-d3fd7",
  storageBucket: "chess-d3fd7.firebasedstorage.app",
  messagingSenderId: "189397425670",
  appId: "1:189397425670:web:fc75951cef1bef0db82d87"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* üîó GAME SETUP */
const game = new Chess();
let myColor = null;
let gameEnded = false;

/* GET GAME ID FROM HASH OR CREATE NEW */
let gameId = location.hash.slice(1);
if(!gameId) {
  gameId = Math.random().toString(36).slice(2);
  location.hash = gameId;
}

const gameRef = db.ref("games/" + gameId);

/* ‚ôü BOARD */
const board = Chessboard('board', {
  draggable: true,
  position: 'start',
  onDrop: (from, to) => {
    if(gameEnded) return "snapback";
    if(game.turn() !== myColor) return "snapback";

    const move = game.move({ from, to, promotion: 'q' });
    if(!move) return "snapback";

    updateGameState();
  }
});

/* üë§ ASSIGN COLOR & WAIT FOR PLAYER */
const playersRef = gameRef.child("players");

playersRef.on("value", snap => {
  const players = snap.val() || {};

  if(!myColor){
    if(!players.white){
      myColor = 'w';
      playersRef.update({ white:true });
      document.getElementById("status").innerText = "–¢—ã –∏–≥—Ä–∞–µ—à—å –∑–∞ –ë–ï–õ–´–•";
    } else if(!players.black){
      myColor = 'b';
      playersRef.update({ black:true });
      document.getElementById("status").innerText = "–¢—ã –∏–≥—Ä–∞–µ—à—å –∑–∞ –ß–Å–†–ù–´–•";
    }
  }
});

/* üîÑ LISTEN FOR GAME STATE */
gameRef.child("fen").on("value", snap => {
  const fen = snap.val();
  if(fen) {
    game.load(fen);
    board.position(fen);
  }
});

gameRef.child("status").on("value", snap => {
  const status = snap.val();
  if(status === "mate") showResult("–ú–∞—Ç! –ü–æ–±–µ–¥–∏–ª " + (game.turn() === 'w' ? "—á—ë—Ä–Ω—ã–π" : "–±–µ–ª—ã–π"));
  if(status === "draw") showResult("–ù–∏—á—å—è");
});

/* üì° UPDATE GAME STATE */
function updateGameState(){
  let status = "playing";
  if(game.in_checkmate()) status = "mate";
  else if(game.in_draw()) status = "draw";

  gameRef.child("fen").set(game.fen());
  gameRef.child("status").set(status);
}

/* üèÅ GAME OVER */
function showResult(text){
  gameEnded = true;
  document.getElementById("overlay").style.display = "flex";
  document.getElementById("result").innerText = text;
}

/* üîÅ RESTART */
function restartGame(){
  gameRef.remove();
  location.reload();
}
</script>

</body>
</html>

